<!DOCTYPE html>
<html>

<head>
    <title>Rigid body - Physijs</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css" />
    <script type="text/javascript" src="three/three.js"></script>
    <script type="text/javascript" src="physijs/physi.js"></script>
    <script type="text/javascript" src="three/OrbitControls.js"></script>
    <script type="text/javascript">
    'use strict';

    Physijs.scripts.worker = 'physijs/physijs_worker.js';
    Physijs.scripts.ammo = 'ammo.js';

    var initScene, render,
        ground_material, box_material,
        renderer, scene, ground, light, camera,
        vehicle_body, vehicle, loader;

    initScene = function() {
        renderer = new THREE.WebGLRenderer({
            antialias: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMapSoft = true;
        document.getElementById('viewport').appendChild(renderer.domElement);

        scene = new Physijs.Scene;
        scene.setGravity(new THREE.Vector3(0, -30, 0));
        scene.addEventListener(
            'update',
            function() {

                if (window.input && vehicle) {
                    if (window.input.direction !== null) {
                        window.input.steering += window.input.direction / 50;
                        if (window.input.steering < -.6) window.input.steering = -.6;
                        if (window.input.steering > .6) window.input.steering = .6;
                    }
                    vehicle.setSteering(window.input.steering, 0);
                    vehicle.setSteering(window.input.steering, 1);

                    if (window.input.power === true) {
                        vehicle.applyEngineForce(200);
                    } else if (window.input.power === false) {
                        vehicle.setBrake(20, 2);
                        vehicle.setBrake(20, 3);
                    } else {
                        vehicle.applyEngineForce(0);
                    }
                }

                scene.simulate();
            }
        );

        camera = new THREE.PerspectiveCamera(
            35,
            window.innerWidth / window.innerHeight,
            1,
            1000
        );
        scene.add(camera);

        // Loader
        loader = new THREE.TextureLoader();

        // Materials
        ground_material = new THREE.MeshLambertMaterial({
            color: 'green'
        });


        var ground_geometry = new THREE.BoxGeometry(300, 5, 300);

        ground = new Physijs.BoxMesh(
            ground_geometry,
            ground_material,
            0 // mass
        );
        ground.position.y = -4;
        ground.receiveShadow = true;
        scene.add(ground);

        var controls = new THREE.OrbitControls(camera, renderer.domElement);

        var mesh = new Physijs.BoxMesh(
            new THREE.BoxGeometry(3, 1.5, 6),
            new THREE.MeshStandardMaterial({
                color: 'red'
            })
        );
        mesh.position.y = 2;
        mesh.castShadow = mesh.receiveShadow = true;




        vehicle = new Physijs.Vehicle(mesh, new Physijs.VehicleTuning(
            10.88,
            1.83,
            0.28,
            500,
            10.5,
            6000
        ));
        scene.add(vehicle);

        var wheel_material = new THREE.MeshStandardMaterial({
            color: 'black'
        });

        let wheels = {
            frontLeft: {
                position: new THREE.Vector3(1.2, -1, 2)
            },
            frontRight: {
                position: new THREE.Vector3(-1.2, -1, 2)
            },
            backLeft: {
                position: new THREE.Vector3(1.2, -1, -2)
            },
            backRight: {
                position: new THREE.Vector3(-1.2, -1, -2)
            }
        }

        let wheelRadius = 0.7;
        let wheel = new THREE.CylinderGeometry(wheelRadius, wheelRadius, 0.6, 20);
        for (let position in wheels) {
            let wheelPos = wheels[position].position;
            vehicle.addWheel(
                wheel,
                wheel_material,
                wheelPos,
                new THREE.Vector3(0, -1, 0),
                new THREE.Vector3(-1, 0, 0),
                0.5,
                wheelRadius,
                position.includes('front')
            );
        }
        camera.position.copy(vehicle.mesh.position).add(new THREE.Vector3(40, 25, 40));
        camera.lookAt(new THREE.Vector3);

        let l = new THREE.AmbientLight();
        l.intensity = 0.6;
        scene.add(l);


        window.input = {
            power: null,
            direction: null,
            steering: 0
        };
        document.addEventListener('keydown', function(ev) {
            switch (ev.keyCode) {
                case 37: // left
                    window.input.direction = 1;
                    break;

                case 38: // forward
                    window.input.power = true;
                    break;

                case 39: // right
                    window.input.direction = -1;
                    break;

                case 40: // back
                    window.input.power = false;
                    break;
            }
        });
        document.addEventListener('keyup', function(ev) {
            switch (ev.keyCode) {
                case 37: // left
                    window.input.direction = null;
                    break;

                case 38: // forward
                    window.input.power = null;
                    break;

                case 39: // right
                    window.input.direction = null;
                    break;

                case 40: // back
                    window.input.power = null;
                    break;
            }
        });

        requestAnimationFrame(render);
        scene.simulate();
    };

    render = function() {
        requestAnimationFrame(render);
        renderer.render(scene, camera);
    };

    window.onload = initScene;
    </script>
</head>

<body>
    <div style="position: fixed; top:0; left:0;" id="viewport"></div>
</body>

</html>
